rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuth()
        && get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == "admin";
    }

    /* =========================
       ðŸ‘¤ USERS
       ========================= */
    match /user/{userId} {

      // Read own profile or admin
      allow read: if isAdmin() || (isAuth() && request.auth.uid == userId);

      // âœ… Coach self-registration (AUTHENTICATED)
      allow create: if isAuth()
        && request.auth.uid == userId
        && request.resource.data.role == "coach"
        && request.resource.data.name is string
        && request.resource.data.phone is string;

      // âœ… Admin self-registration (pending only)
      allow create: if isAuth()
        && request.auth.uid == userId
        && request.resource.data.role == "admin"
        && request.resource.data.status == "pending"
        && request.resource.data.isCoreAdmin == false
        && request.resource.data.name is string
        && request.resource.data.email is string;

      // Admin management
      allow update, delete: if isAdmin();
    }

    /* =========================
       ðŸ‘¥ CLIENTS
       ========================= */
    match /clients/{clientId} {

      // Admins: everything
      allow read, write, delete: if isAdmin();

      // Coaches: create own clients
      allow create: if isAuth()
        && request.resource.data.assignedCoachId == request.auth.uid;

      // Coaches: manage own clients
      allow read, update, delete: if isAuth()
        && resource.data.assignedCoachId == request.auth.uid;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
